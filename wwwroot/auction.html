<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Auction Page</title>
    </head>
    <body>
        <header>
            <h1>Auction Page</h1>
            <div>ğŸ‘§ğŸ» = <b id="count">0</b></div>
            <link rel="stylesheet" href="css/auction.css" type="text/css" />
        </header>

        <main>
            <ul id="priceMsg"></ul>
        </main>

        <footer>
            <form id="priceForm" autocomplete="off">
                <input type="text" id="price" placeholder="Enter Bid Price" autofocus>
                <button type="button" id="image">Send</button>
                <button type="button" id="leave">Leave</button>
            </form>
        </footer>

        <script src="js/jquery.slim.js"></script>
        <script src="js/signalr.js"></script>
        <script src="js/app.js"></script>
        <script>
            // leave button =====================================================
            $('#leave').click(e => location = '/');

            // General Functions ==================================================
            const m = $('main')[0];
            let bottom = true;

            function isBottom() {
                bottom = m.scrollTop + m.clientHeight + 10 >= m.scrollHeight;
            }

            function scrollToBottom() {
                if (bottom) {
                    m.scrollTop = m.scrollHeight;
                }
            }

            // Connection Setup ===================================================
            const con = new signalR.HubConnectionBuilder()
                .withUrl(`/hub?name=${encodeURIComponent(name)}`)
                .build();

            con.on('ReceiveText', (name, message, who) => {
                message = message
                    .split(':)').join('ğŸ˜Š')
                    .split(':(').join('ğŸ˜¥')
                    .split('<3').join('â¤ï¸');
                
                message = $('<div>').text(message).html();
                
                // TODO(1): Text-to-hyperlink transform
                message = message.replace(
                    /(?<=^|\s)(https?:\/\/\S+)(?=$|\s)/gi, 
                    '<a target="_blank" href="$&">$&</a>'
                );

                isBottom();
                $('#priceMsg').append(`
                    <li class="${who}">
                        <div>
                            <b>${name}:</b> ${message}
                        </div>
                    </li>
                `);
                scrollToBottom();
            });

            con.on('UpdateStatus', (count, status) => {
                $('#count').text(count);

                isBottom();
                $('#chat').append(`
                    <li class="status">
                        <div>${status}</div>
                    </li>
                `);
                scrollToBottom();
            });

            con.onclose(err => location = '/');

            // Start ==============================================================
            con.start().then(main);

            function main() {
                
                $('#form').submit(e => {
                    e.preventDefault();
                    let message = $('#price').val().trim();
                    if (message) {
                        // Send text
                        con.invoke('SendText', name, message);
                    }
                    $('#price').val('').focus();
                });
            }
        </script>
    </body>
</html>
